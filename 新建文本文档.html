<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>M2 Mobile Group - Leave</title>

<style>
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:#f4f6f8}
header{background:#d32f2f;color:#fff;padding:14px;text-align:center;font-size:18px;font-weight:600}
.view{display:none;padding-bottom:70px}
.view.active{display:block}

/* calendar */
.calendar{padding:12px}
.month{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;font-weight:600}
.weekdays,.days{display:grid;grid-template-columns:repeat(7,1fr)}
.weekdays div{text-align:center;font-size:12px;color:#666}
.day{background:#fff;margin:4px;border-radius:10px;height:60px;padding:6px;position:relative;cursor:pointer}
.day.today{border:2px solid #d32f2f}
.day.selected{outline:2px solid #1976d2}
.empty{background:transparent}
.dot{width:8px;height:8px;border-radius:50%;position:absolute;bottom:6px;left:50%;transform:translateX(-50%)}
.green{background:#4caf50}
.red{background:#f44336}

/* cards */
.card{background:#fff;margin:12px;padding:12px;border-radius:12px}
.date-title{margin-top:8px;font-weight:600}
.status-over{color:#f44336;font-weight:600}

/* button */
button{
  width:calc(100% - 24px);
  margin:12px;
  padding:14px;
  border:none;
  border-radius:12px;
  background:#d32f2f;
  color:#fff;
  font-size:16px;
}

/* tab bar */
.tabbar{
  position:fixed;
  bottom:0;left:0;right:0;
  height:60px;
  background:#fff;
  border-top:1px solid #ddd;
  display:flex;
}
.tab{
  flex:1;
  text-align:center;
  padding-top:6px;
  font-size:13px;
  color:#777;
  cursor:pointer;
}
.tab.active{color:#d32f2f;font-weight:600}

/* modal */
.modal{
  position:fixed;left:0;top:0;right:0;bottom:0;
  background:rgba(0,0,0,.4);
  display:none;align-items:flex-end
}
.modal.active{display:flex}
.sheet{
  background:#fff;width:100%;
  border-radius:16px 16px 0 0;
  padding:16px
}
.sheet select,.sheet input{
  width:100%;padding:12px;margin-bottom:10px
}
</style>
</head>

<body>

<header>M2 Mobile Group</header>

<!-- TAB 1 -->
<div id="tabCalendar" class="view active">
  <div class="calendar">
    <div class="month">
      <span onclick="changeMonth(-1)">â—€</span>
      <span id="monthTitle"></span>
      <span onclick="changeMonth(1)">â–¶</span>
    </div>

    <div class="weekdays">
      <div>Sun</div><div>Mon</div><div>Tue</div>
      <div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
    </div>

    <div class="days" id="days"></div>
  </div>

  <button onclick="openModal()">+ Add Leave</button>
</div>

<!-- TAB 2 -->
<div id="tabLeave" class="view">
  <div class="card">
    <b>Monthly Leave List</b>
    <div id="monthLeave"></div>
  </div>
</div>

<!-- TAB 3 -->
<div id="tabFine" class="view">
  <div class="card">
    <b>Monthly Fine Details</b>
    <div id="monthFineList"></div>
    <hr>
    <b>Total Fine This Month: </b>
    <span id="monthFineTotal">0 MMK</span>
  </div>
</div>

<!-- TAB BAR -->
<div class="tabbar">
  <div class="tab active" onclick="switchTab('Calendar',this)">ðŸ“…<br>Calendar</div>
  <div class="tab" onclick="switchTab('Leave',this)">ðŸ‘¥<br>Leave</div>
  <div class="tab" onclick="switchTab('Fine',this)">ðŸ’°<br>Fine</div>
</div>

<!-- MODAL -->
<div id="modal" class="modal">
  <div class="sheet">
    <select id="emp"></select>
    <input id="reason" placeholder="Leave Reason">
    <button onclick="submitLeave()">Submit</button>
    <button onclick="closeModal()" style="background:#999">Cancel</button>
  </div>
</div>

<script>
/* ===== GAS API ===== */
const API = "https://script.google.com/macros/s/AKfycbxKf058FIRTwq8OP6CHh1gurq_YemXQ-MIW966DB1fbLxwFFjs7OQDTf-Vy9SLnMv3C3w/exec";

/* ===== DATA ===== */
const FINE = 5000;
const leaves = {};
let current = new Date();
let selectedDate = new Date().toISOString().slice(0,10);

const daysBox = document.getElementById('days');
const monthTitle = document.getElementById('monthTitle');

/* ===== LOAD EMPLOYEES ===== */
function loadEmployees(){
  fetch(API + "?type=employees")
    .then(res => res.json())
    .then(list => {
      emp.innerHTML = "";
      list.forEach(e => {
        const opt = document.createElement("option");
        opt.value = e.empId;
        opt.textContent = e.name;
        opt.dataset.name = e.name;
        emp.appendChild(opt);
      });
    });
}

/* ===== LOAD LEAVE DATA (å…³é”®ï¼šåˆ·æ–°è¿˜èƒ½çœ‹åˆ°è®°å½•) ===== */
function loadLeaveData(){
  fetch(API)
    .then(res => res.json())
    .then(list => {
      list.forEach(item => {
        if(!leaves[item.date]) leaves[item.date] = [];
        leaves[item.date].push({
          name: item.name,
          reason: item.reason,
          fine: item.fine
        });
      });
      renderCalendar();
      renderMonthLeave();
      renderMonthFine();
    });
}

/* ===== CALENDAR ===== */
function renderCalendar(){
  daysBox.innerHTML='';
  const y=current.getFullYear(), m=current.getMonth();
  monthTitle.innerText=current.toLocaleString('en',{month:'long',year:'numeric'});
  const first=new Date(y,m,1).getDay();
  const total=new Date(y,m+1,0).getDate();
  const today=new Date();

  for(let i=0;i<first;i++) daysBox.innerHTML+='<div class="day empty"></div>';

  for(let d=1;d<=total;d++){
    const key=`${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const div=document.createElement('div');
    div.className='day';
    div.innerHTML=`<span>${d}</span>`;

    if(d===today.getDate()&&m===today.getMonth()&&y===today.getFullYear())
      div.classList.add('today');

    if(key===selectedDate)
      div.classList.add('selected');

    if(leaves[key]){
      const dot=document.createElement('div');
      dot.className='dot '+(leaves[key].length>2?'red':'green');
      div.appendChild(dot);
    }

    div.onclick=()=>{ selectedDate = key; renderCalendar(); };
    daysBox.appendChild(div);
  }
}

/* ===== SUBMIT ===== */
function submitLeave(){
  const empId = emp.value;
  const name = emp.options[emp.selectedIndex].dataset.name;
  const arr = leaves[selectedDate] || [];
  const fine = arr.length >= 2 ? FINE : 0;

  fetch(API,{
    method:"POST",
    body:JSON.stringify({
      date:selectedDate,
      empId,
      name,
      reason:reason.value||"-",
      fine
    })
  });

  arr.push({name,reason:reason.value||"-",fine});
  leaves[selectedDate]=arr;

  closeModal();
  renderCalendar();
  renderMonthLeave();
  renderMonthFine();
}

/* ===== LISTS ===== */
function renderMonthLeave(){
  monthLeave.innerHTML='';
  const y=current.getFullYear(), m=String(current.getMonth()+1).padStart(2,'0');
  Object.keys(leaves).filter(d=>d.startsWith(`${y}-${m}`)).sort().forEach(d=>{
    monthLeave.innerHTML+=`<div class="date-title">${d}</div>`;
    leaves[d].forEach(l=>{
      monthLeave.innerHTML+=`<div>${l.name} â€“ ${l.reason}</div>`;
    });
  });
}

function renderMonthFine(){
  monthFineList.innerHTML='';
  let total=0;
  const y=current.getFullYear(), m=String(current.getMonth()+1).padStart(2,'0');
  Object.keys(leaves).filter(d=>d.startsWith(`${y}-${m}`)).forEach(d=>{
    leaves[d].forEach(l=>{
      if(l.fine){
        total+=l.fine;
        monthFineList.innerHTML+=
          `<div class="status-over">${d} â€“ ${l.name} â€“ ${l.fine} MMK</div>`;
      }
    });
  });
  monthFineTotal.innerText = total+" MMK";
}

/* ===== UI ===== */
function changeMonth(step){
  current.setMonth(current.getMonth()+step);
  renderCalendar();renderMonthLeave();renderMonthFine();
}
function switchTab(name,el){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab'+name).classList.add('active');
  el.classList.add('active');
}
function openModal(){modal.classList.add('active')}
function closeModal(){modal.classList.remove('active');reason.value=''}

/* ===== INIT ===== */
loadEmployees();
loadLeaveData();
</script>

</body>
</html>